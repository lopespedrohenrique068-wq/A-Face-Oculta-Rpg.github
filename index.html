<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema RPG - Fichas e Campanhas</title>

<style>
/* ESTILOS DA TELA DE LOGIN E DASHBOARD */
body {
  background: #0b0b0b;
  color: #eee;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}

.hidden {
  display: none !important;
}

/* TELA DE LOGIN */
.login-screen {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: #0b0b0b;
}

.login-container {
  background: #111;
  padding: 40px;
  border-radius: 10px;
  border: 1px solid #333;
  width: 90%;
  max-width: 400px;
  text-align: center;
}

.login-container h1 {
  margin-bottom: 30px;
  color: #fff;
}

.login-container input {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  background: #222;
  border: 1px solid #333;
  color: #fff;
  border-radius: 5px;
  font-size: 16px;
}

.login-container button {
  width: 100%;
  padding: 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin-top: 20px;
  font-weight: bold;
  font-size: 16px;
}

.login-container button:hover {
  background: #2563eb;
}

.error-message {
  color: #f44336;
  margin-top: 10px;
  font-size: 14px;
}

/* DASHBOARD */
.dashboard-screen {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid #333;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.user-avatar {
  width: 50px;
  height: 50px;
  background: #3b82f6;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 20px;
}

.dashboard-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 30px;
  padding-bottom: 10px;
  border-bottom: 1px solid #333;
  flex-wrap: wrap;
}

.tab-btn {
  padding: 10px 20px;
  background: #222;
  border: none;
  color: #eee;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.3s;
}

.tab-btn:hover {
  background: #333;
}

.tab-btn.active {
  background: #3b82f6;
}

/* CARDS DAS FICHAS */
.cards-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.character-card {
  background: #111;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 20px;
  transition: all 0.3s;
}

.character-card:hover {
  border-color: #3b82f6;
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.card-title {
  font-size: 18px;
  font-weight: bold;
  color: #fff;
}

.card-actions {
  display: flex;
  gap: 8px;
}

.btn-icon {
  background: #333;
  border: none;
  color: #eee;
  width: 30px;
  height: 30px;
  border-radius: 5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-icon:hover {
  background: #444;
}

.btn-icon.delete:hover {
  background: #f44336;
  color: white;
}

.card-content {
  color: #aaa;
  font-size: 14px;
  margin-bottom: 15px;
}

.card-content p {
  margin: 5px 0;
}

.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #333;
}

.btn-primary {
  background: #3b82f6;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-secondary {
  background: #333;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
}

.btn-secondary:hover {
  background: #444;
}

/* MODAIS */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: #111;
  padding: 30px;
  border-radius: 10px;
  border: 1px solid #333;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-header h2 {
  color: #fff;
  margin: 0;
}

.close-modal {
  background: none;
  border: none;
  color: #888;
  font-size: 24px;
  cursor: pointer;
  line-height: 1;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #aaa;
  font-size: 14px;
}

.form-group input, .form-group textarea, .form-group select {
  width: 100%;
  padding: 10px;
  background: #222;
  border: 1px solid #333;
  color: #fff;
  border-radius: 5px;
  font-size: 14px;
}

.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 30px;
}

/* ADMIN SECTION */
.admin-section {
  background: #111;
  padding: 20px;
  border-radius: 10px;
  border: 1px solid #333;
  margin-top: 30px;
}

.admin-section h3 {
  color: #3b82f6;
  margin-bottom: 15px;
}

.access-codes-list {
  background: #222;
  padding: 15px;
  border-radius: 5px;
  margin-top: 10px;
  max-height: 300px;
  overflow-y: auto;
}

.code-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #333;
}

.code-item:last-child {
  border-bottom: none;
}

/* ESTILOS DA FICHA (MANTENDO O DESIGN ORIGINAL) */
.character-screen {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.back-button {
  background: #333;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  margin-bottom: 20px;
  font-size: 14px;
}

.back-button:hover {
  background: #444;
}

.container {
  display: grid;
  grid-template-columns: 1fr 1.3fr 1fr;
  gap: 20px;
}

.box {
  background: #111;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
}

h1, h2, h3 {
  color: #fff;
  margin-bottom: 10px;
}

label {
  display: block;
  margin-top: 8px;
  font-size: 14px;
  color: #eee;
}

input, select, button, textarea {
  width: 100%;
  margin-top: 4px;
  padding: 6px;
  border-radius: 6px;
  border: none;
  font-size: 14px;
  box-sizing: border-box;
}

input[type="number"] {
  width: 80px;
}

button {
  background: #222;
  color: #fff;
  cursor: pointer;
  transition: background 0.3s;
  margin-bottom: 5px;
}

button:hover {
  background: #333;
}

button.small {
  padding: 4px 8px;
  font-size: 12px;
  width: auto;
}

/* PER√çCIAS */
.pericia {
  border-bottom: 1px solid #222;
  padding: 6px 0;
  display: flex;
  flex-direction: column;
}

.pericia-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.pericia select {
  width: auto;
  min-width: 100px;
}

.pericia strong {
  min-width: 120px;
  font-size: 13px;
}

.small {
  font-size: 12px;
  color: #aaa;
}

/* BARRAS DE STATUS */
.barra-container {
  margin: 10px 0;
}

.barra-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
}

.barra {
  height: 8px;
  background: #222;
  border-radius: 6px;
  margin-top: 6px;
  overflow: hidden;
}

.barra span {
  display: block;
  height: 100%;
  background: #3b82f6;
  transition: width 0.3s;
}

/* HIST√ìRICO */
.historico-item {
  background: #222;
  padding: 8px;
  margin: 5px 0;
  border-radius: 4px;
  border-left: 3px solid #3b82f6;
  font-size: 12px;
}

/* MODIFICADORES */
.modificador-section {
  background: #222;
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
}

.modificador-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 5px 0;
}

.modificador-value {
  font-size: 18px;
  font-weight: bold;
  color: #3b82f6;
}

/* TABS DA FICHA */
.tab-buttons {
  display: flex;
  gap: 5px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.tab-btn {
  background: #222;
  border: none;
  color: white;
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 5px;
  flex: 1;
  min-width: 80px;
  font-size: 12px;
}

.tab-btn.active {
  background: #3b82f6;
}

.tab {
  display: none;
}

.tab.active {
  display: block;
}

/* DADOS */
.dados-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 15px 0;
}

.dado-btn {
  width: 60px;
  height: 60px;
  font-size: 20px;
  background: #333;
}

/* DEFESA */
.defesa-info {
  background: #222;
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
  border-left: 3px solid #3b82f6;
}

.defesa-item {
  margin: 5px 0;
  padding: 5px;
  background: #333;
  border-radius: 3px;
}

.roll-btn {
  background: #444;
  border: none;
  color: white;
  padding: 4px 8px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
  margin-left: 5px;
}

/* ATRIBUTOS */
.atributo-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 8px 0;
}

.attribute-roll-btn {
  background: #333;
  border: none;
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
}

/* HABILIDADES E CONJURA√á√ïES */
.habilidade-item, .conjuracao-item {
  background: #222;
  padding: 10px;
  margin: 10px 0;
  border-radius: 5px;
  border-left: 4px solid #4CAF50;
}

.conjuracao-item {
  border-left-color: #9C27B0;
}

.habilidade-header, .conjuracao-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.habilidade-nome, .conjuracao-nome {
  font-weight: bold;
  font-size: 16px;
}

.habilidade-stats, .conjuracao-stats {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 8px 0;
  font-size: 12px;
}

.stat-badge {
  background: #333;
  padding: 3px 8px;
  border-radius: 10px;
  display: inline-block;
}

.elemento-badge {
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: bold;
  color: white;
}

.gravidade { background: #795548; }
.eletromagnetismo { background: #2196F3; }
.nuclear-fraca { background: #FF9800; }
.nuclear-forte { background: #F44336; }

.tecnologia-badge {
  background: #607D8B;
  color: white;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 10px;
  margin-left: 5px;
}

.habilidade-desc, .conjuracao-desc {
  font-size: 12px;
  color: #aaa;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #333;
}

.empty-state {
  text-align: center;
  padding: 20px;
  color: #666;
  font-style: italic;
}

.ataque-btn {
  background: #FF5722;
  border: none;
  color: white;
  padding: 4px 8px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
}

.ataque-btn:hover {
  background: #E64A19;
}

/* MODAIS PARA HABILIDADES E CONJURA√á√ïES */
.form-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.form-row .form-group {
  flex: 1;
}

.dano-info {
  background: #333;
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
}

/* RESPONSIVIDADE */
@media (max-width: 1024px) {
  .container {
    grid-template-columns: 1fr;
  }
  
  .cards-container {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  }
}

@media (max-width: 768px) {
  .dashboard-header {
    flex-direction: column;
    gap: 15px;
    align-items: flex-start;
  }
  
  .dashboard-tabs {
    justify-content: center;
  }
  
  .cards-container {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<!-- TELA DE LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-container">
    <h1>üé≤ Sistema RPG</h1>
    <p style="color: #aaa; margin-bottom: 30px;">Entre com seu c√≥digo de acesso</p>
    <input type="text" id="accessCode" placeholder="Digite seu c√≥digo de acesso">
    <button onclick="login()">Entrar no Sistema</button>
    <div id="loginError" class="error-message hidden"></div>
    <div style="margin-top: 20px; color: #666; font-size: 12px;">
      <p>Se voc√™ n√£o tem um c√≥digo, pe√ßa ao mestre</p>
    </div>
  </div>
</div>

<!-- DASHBOARD PRINCIPAL -->
<div id="dashboardScreen" class="dashboard-screen hidden">
  <div class="dashboard-header">
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">U</div>
      <div>
        <h2 id="userName">Usu√°rio</h2>
        <small style="color: #666;">C√≥digo: <span id="userCode"></span></small>
      </div>
    </div>
    <button class="btn-secondary" onclick="logout()">Sair</button>
  </div>

  <div class="dashboard-tabs">
    <button class="tab-btn active" onclick="openDashboardTab('fichas')">üìÑ Minhas Fichas</button>
    <button class="tab-btn" onclick="openDashboardTab('campanhas')">üó∫Ô∏è Campanhas</button>
    <button class="tab-btn" onclick="openDashboardTab('admin')" id="adminTabBtn">üëë Administra√ß√£o</button>
  </div>

  <!-- ABA FICHAS -->
  <div id="tabFichas" class="dashboard-tab">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3>Minhas Fichas de Personagem</h3>
      <button class="btn-primary" onclick="openCreateCharacterModal()">+ Nova Ficha</button>
    </div>
    <div id="characterCards" class="cards-container">
      <!-- Fichas ser√£o carregadas aqui -->
    </div>
  </div>

  <!-- ABA CAMPANHAS -->
  <div id="tabCampanhas" class="dashboard-tab hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3>Campanhas</h3>
      <button class="btn-primary" onclick="openCreateCampaignModal()">+ Nova Campanha</button>
    </div>
    <div id="campaignCards" class="cards-container">
      <!-- Campanhas ser√£o carregadas aqui -->
    </div>
  </div>

  <!-- ABA ADMIN -->
  <div id="tabAdmin" class="dashboard-tab hidden">
    <div class="admin-section">
      <h3>üëë Painel de Administra√ß√£o</h3>
      <p style="color: #aaa; margin-bottom: 15px;">Gerencie c√≥digos de acesso para seus jogadores</p>
      
      <div class="form-group">
        <label>Criar novo c√≥digo de acesso</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="newAccessCode" placeholder="Digite o c√≥digo desejado">
          <button class="btn-primary" onclick="createAccessCode()">Criar C√≥digo</button>
        </div>
      </div>
      
      <div class="form-group">
        <label>C√≥digos de acesso ativos:</label>
        <div id="accessCodesList" class="access-codes-list">
          <!-- C√≥digos ser√£o listados aqui -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TELA DA FICHA -->
<div id="characterScreen" class="character-screen hidden">
  <button class="back-button" onclick="backToDashboard()">‚Üê Voltar ao Dashboard</button>
  <div id="characterSheetContainer"></div>
</div>

<!-- MODAL CRIAR FICHA -->
<div id="createCharacterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Criar Nova Ficha</h2>
      <button class="close-modal" onclick="closeCreateCharacterModal()">√ó</button>
    </div>
    <div class="form-group">
      <label>Nome do Personagem</label>
      <input type="text" id="newCharacterName" placeholder="Ex: Aragorn">
    </div>
    <div class="form-group">
      <label>Idade</label>
      <input type="number" id="newCharacterAge" placeholder="25" value="25">
    </div>
    <div class="form-group">
      <label>Origem</label>
      <input type="text" id="newCharacterOrigin" placeholder="Ex: Guerreiro do Norte">
    </div>
    <div class="form-actions">
      <button class="btn-primary" onclick="createNewCharacter()">Criar Ficha</button>
      <button class="btn-secondary" onclick="closeCreateCharacterModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL CRIAR HABILIDADE -->
<div id="createHabilidadeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Criar Nova Habilidade</h2>
      <button class="close-modal" onclick="closeCreateHabilidadeModal()">√ó</button>
    </div>
    <div class="form-group">
      <label>Nome da Habilidade</label>
      <input type="text" id="habilidadeNome" placeholder="Ex: Resist√™ncia Sobrenatural">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Modificador de Vida</label>
        <input type="number" id="habilidadeVida" value="0">
      </div>
      <div class="form-group">
        <label>Modificador de Sanidade</label>
        <input type="number" id="habilidadeSanidade" value="0">
      </div>
      <div class="form-group">
        <label>Modificador de Fadiga</label>
        <input type="number" id="habilidadeFadiga" value="0">
      </div>
    </div>
    <div class="form-group">
      <label>Descri√ß√£o</label>
      <textarea id="habilidadeDesc" rows="4" placeholder="Descreva a habilidade..."></textarea>
    </div>
    <div class="form-actions">
      <button class="btn-primary" onclick="salvarHabilidade()">Salvar Habilidade</button>
      <button class="btn-secondary" onclick="closeCreateHabilidadeModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL CRIAR CONJURA√á√ÉO -->
<div id="createConjuracaoModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Criar Nova Conjura√ß√£o</h2>
      <button class="close-modal" onclick="closeCreateConjuracaoModal()">√ó</button>
    </div>
    <div class="form-group">
      <label>Nome da Conjura√ß√£o</label>
      <input type="text" id="conjuracaoNome" placeholder="Ex: Campo de For√ßa">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Elemento</label>
        <select id="conjuracaoElemento">
          <option value="gravidade">Gravidade</option>
          <option value="eletromagnetismo">Eletromagnetismo</option>
          <option value="nuclear-fraca">Nuclear Fraca</option>
          <option value="nuclear-forte">Nuclear Forte</option>
        </select>
      </div>
      <div class="form-group">
        <label>Tecnologia</label>
        <select id="conjuracaoTecnologia">
          <option value="1">1¬™ Tecnologia</option>
          <option value="2">2¬™ Tecnologia</option>
          <option value="3">3¬™ Tecnologia</option>
          <option value="4">4¬™ Tecnologia</option>
        </select>
      </div>
    </div>
    <div class="dano-info">
      <h4>Sistema de Dano</h4>
      <div class="form-row">
        <div class="form-group">
          <label>Dados de Dano (ex: 2d6)</label>
          <input type="text" id="conjuracaoDano" placeholder="2d6" value="1d6">
        </div>
        <div class="form-group">
          <label>Modificador de Dano</label>
          <input type="number" id="conjuracaoModDano" value="0">
        </div>
      </div>
    </div>
    <div class="form-group">
      <label>Descri√ß√£o</label>
      <textarea id="conjuracaoDesc" rows="4" placeholder="Descreva a conjura√ß√£o..."></textarea>
    </div>
    <div class="form-actions">
      <button class="btn-primary" onclick="salvarConjuracao()">Salvar Conjura√ß√£o</button>
      <button class="btn-secondary" onclick="closeCreateConjuracaoModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL CRIAR CAMPANHA -->
<div id="createCampaignModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Criar Nova Campanha</h2>
      <button class="close-modal" onclick="closeCreateCampaignModal()">√ó</button>
    </div>
    <div class="form-group">
      <label>Nome da Campanha</label>
      <input type="text" id="newCampaignName" placeholder="Ex: A Jornada do Anel">
    </div>
    <div class="form-group">
      <label>Descri√ß√£o</label>
      <textarea id="newCampaignDesc" rows="3" placeholder="Descreva sua campanha..."></textarea>
    </div>
    <div class="form-actions">
      <button class="btn-primary" onclick="createNewCampaign()">Criar Campanha</button>
      <button class="btn-secondary" onclick="closeCreateCampaignModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL CONVIDAR PARA CAMPANHA -->
<div id="inviteToCampaignModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Convidar para Campanha</h2>
      <button class="close-modal" onclick="closeInviteModal()">√ó</button>
    </div>
    <div class="form-group">
      <label>C√≥digo de convite:</label>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="campaignInviteCode" readonly style="background: #333;">
        <button class="btn-secondary" onclick="copyInviteCode()">Copiar</button>
      </div>
    </div>
    <p style="color: #aaa; font-size: 12px; margin-top: 10px;">
      Compartilhe este c√≥digo com os jogadores para que eles possam entrar na campanha.
    </p>
  </div>
</div>

<script>
// ========== SISTEMA DE AUTENTICA√á√ÉO ==========

let accessCodes = {
  'kairaf123098': { name: 'Mestre', isAdmin: true },
  'jogador1': { name: 'Jogador 1', isAdmin: false },
  'jogador2': { name: 'Jogador 2', isAdmin: false }
};

let currentUser = null;
let userData = {
  characters: [],
  campaigns: []
};

// ========== FUN√á√ïES DE AUTENTICA√á√ÉO ==========

function login() {
  const code = document.getElementById('accessCode').value.trim();
  const errorDiv = document.getElementById('loginError');
  
  if (!code) {
    errorDiv.textContent = 'Digite um c√≥digo de acesso';
    errorDiv.classList.remove('hidden');
    return;
  }
  
  if (accessCodes[code]) {
    currentUser = {
      code: code,
      name: accessCodes[code].name,
      isAdmin: accessCodes[code].isAdmin
    };
    
    // Carregar dados do usu√°rio
    loadUserData();
    
    // Atualizar interface
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userCode').textContent = currentUser.code;
    document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
    
    // Mostrar/ocultar bot√£o de admin
    document.getElementById('adminTabBtn').classList.toggle('hidden', !currentUser.isAdmin);
    
    // Trocar telas
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('dashboardScreen').classList.remove('hidden');
    
    // Carregar conte√∫do
    loadCharacters();
    loadCampaigns();
    loadAccessCodesList();
    
  } else {
    errorDiv.textContent = 'C√≥digo de acesso inv√°lido';
    errorDiv.classList.remove('hidden');
  }
}

function logout() {
  currentUser = null;
  document.getElementById('accessCode').value = '';
  document.getElementById('loginError').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('dashboardScreen').classList.add('hidden');
  document.getElementById('characterScreen').classList.add('hidden');
}

// ========== SISTEMA DE DADOS ==========

function loadUserData() {
  const saved = localStorage.getItem(`rpg_user_${currentUser.code}`);
  if (saved) {
    userData = JSON.parse(saved);
  } else {
    userData = {
      characters: [],
      campaigns: []
    };
  }
}

function saveUserData() {
  localStorage.setItem(`rpg_user_${currentUser.code}`, JSON.stringify(userData));
}

function loadAccessCodesList() {
  if (!currentUser.isAdmin) return;
  
  const list = document.getElementById('accessCodesList');
  list.innerHTML = '';
  
  for (const [code, data] of Object.entries(accessCodes)) {
    const div = document.createElement('div');
    div.className = 'code-item';
    div.innerHTML = `
      <div>
        <strong>${code}</strong>
        <div style="color: #666; font-size: 11px;">${data.name} ${data.isAdmin ? '(Admin)' : ''}</div>
      </div>
      <button class="btn-icon" onclick="deleteAccessCode('${code}')" ${code === 'kairaf123098' ? 'disabled style="opacity:0.5"' : ''}>üóëÔ∏è</button>
    `;
    list.appendChild(div);
  }
}

// ========== ADMIN: GERENCIAR C√ìDIGOS ==========

function createAccessCode() {
  if (!currentUser.isAdmin) return;
  
  const newCode = document.getElementById('newAccessCode').value.trim();
  
  if (!newCode) {
    alert('Digite um c√≥digo!');
    return;
  }
  
  if (accessCodes[newCode]) {
    alert('Este c√≥digo j√° existe!');
    return;
  }
  
  const name = prompt('Nome do usu√°rio para este c√≥digo:');
  if (!name) return;
  
  const isAdmin = confirm('Este usu√°rio ser√° administrador?');
  
  accessCodes[newCode] = {
    name: name,
    isAdmin: isAdmin
  };
  
  // Salvar no localStorage
  localStorage.setItem('rpg_access_codes', JSON.stringify(accessCodes));
  
  document.getElementById('newAccessCode').value = '';
  loadAccessCodesList();
  alert('C√≥digo criado com sucesso!');
}

function deleteAccessCode(code) {
  if (!currentUser.isAdmin || code === 'kairaf123098') return;
  
  if (confirm(`Remover c√≥digo ${code}?`)) {
    delete accessCodes[code];
    localStorage.setItem('rpg_access_codes', JSON.stringify(accessCodes));
    loadAccessCodesList();
  }
}

// Carregar c√≥digos do localStorage ao iniciar
(function loadSavedAccessCodes() {
  const saved = localStorage.getItem('rpg_access_codes');
  if (saved) {
    const parsed = JSON.parse(saved);
    accessCodes = { ...accessCodes, ...parsed };
  }
})();

// ========== SISTEMA DE FICHAS ==========

function openCreateCharacterModal() {
  document.getElementById('createCharacterModal').classList.add('active');
}

function closeCreateCharacterModal() {
  document.getElementById('createCharacterModal').classList.remove('active');
}

function createNewCharacter() {
  const name = document.getElementById('newCharacterName').value.trim();
  const age = document.getElementById('newCharacterAge').value;
  const origin = document.getElementById('newCharacterOrigin').value.trim();
  
  if (!name) {
    alert('Digite um nome para o personagem!');
    return;
  }
  
  const newCharacter = {
    id: Date.now(),
    name: name,
    age: parseInt(age) || 25,
    origin: origin || 'Desconhecida',
    createdAt: new Date().toISOString(),
    data: {
      atributos: {
        FOR: 2,
        DES: 2,
        INT: 2,
        CON: 2,
        CONSC: 2,
        CONH: 5
      },
      status: {
        vida: { atual: 10, max: 10 },
        sanidade: { atual: 15, max: 15 },
        fadiga: { atual: 10, max: 10 }
      },
      modificadores: {
        mdh: 0,
        de: 100
      },
      habilidades: [],
      conjuracoes: [],
      pericias: {}
    }
  };
  
  userData.characters.push(newCharacter);
  saveUserData();
  loadCharacters();
  closeCreateCharacterModal();
  
  document.getElementById('newCharacterName').value = '';
  document.getElementById('newCharacterAge').value = '25';
  document.getElementById('newCharacterOrigin').value = '';
}

function loadCharacters() {
  const container = document.getElementById('characterCards');
  container.innerHTML = '';
  
  if (userData.characters.length === 0) {
    container.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
        <p>Nenhuma ficha criada ainda.</p>
        <p>Crie sua primeira ficha para come√ßar!</p>
      </div>
    `;
    return;
  }
  
  userData.characters.forEach(character => {
    const card = document.createElement('div');
    card.className = 'character-card';
    card.innerHTML = `
      <div class="card-header">
        <div class="card-title">${character.name}</div>
        <div class="card-actions">
          <button class="btn-icon" onclick="editCharacter(${character.id})" title="Editar">‚úèÔ∏è</button>
          <button class="btn-icon delete" onclick="deleteCharacter(${character.id})" title="Excluir">üóëÔ∏è</button>
        </div>
      </div>
      <div class="card-content">
        <p><strong>Idade:</strong> ${character.age} anos</p>
        <p><strong>Origem:</strong> ${character.origin}</p>
        <p><strong>PV:</strong> ${character.data.status.vida.atual}/${character.data.status.vida.max}</p>
        <p><strong>Sanidade:</strong> ${character.data.status.sanidade.atual}/${character.data.status.sanidade.max}</p>
      </div>
      <div class="card-footer">
        <button class="btn-primary" onclick="openCharacterSheet(${character.id})">Abrir Ficha</button>
        <small style="color: #666;">${new Date(character.createdAt).toLocaleDateString()}</small>
      </div>
    `;
    container.appendChild(card);
  });
}

function deleteCharacter(id) {
  if (confirm('Tem certeza que quer excluir esta ficha?')) {
    userData.characters = userData.characters.filter(c => c.id !== id);
    saveUserData();
    loadCharacters();
  }
}

function editCharacter(id) {
  const character = userData.characters.find(c => c.id === id);
  if (!character) return;
  
  const newName = prompt('Novo nome do personagem:', character.name);
  if (newName === null) return;
  
  const newAge = prompt('Nova idade:', character.age);
  if (newAge === null) return;
  
  const newOrigin = prompt('Nova origem:', character.origin);
  if (newOrigin === null) return;
  
  character.name = newName.trim();
  character.age = parseInt(newAge) || character.age;
  character.origin = newOrigin.trim();
  
  saveUserData();
  loadCharacters();
}

// ========== SISTEMA DE CAMPANHAS ==========

function openCreateCampaignModal() {
  document.getElementById('createCampaignModal').classList.add('active');
}

function closeCreateCampaignModal() {
  document.getElementById('createCampaignModal').classList.remove('active');
}

function createNewCampaign() {
  const name = document.getElementById('newCampaignName').value.trim();
  const desc = document.getElementById('newCampaignDesc').value.trim();
  
  if (!name) {
    alert('Digite um nome para a campanha!');
    return;
  }
  
  // Gerar c√≥digo de convite √∫nico
  const inviteCode = generateInviteCode();
  
  const newCampaign = {
    id: Date.now(),
    name: name,
    description: desc || 'Sem descri√ß√£o',
    master: currentUser.code,
    masterName: currentUser.name,
    players: [currentUser.code],
    playerNames: [currentUser.name],
    characters: [],
    createdAt: new Date().toISOString(),
    inviteCode: inviteCode
  };
  
  userData.campaigns.push(newCampaign);
  saveUserData();
  
  // Salvar c√≥digo de convite
  saveCampaignInviteCode(inviteCode, newCampaign.id);
  
  loadCampaigns();
  closeCreateCampaignModal();
  
  document.getElementById('newCampaignName').value = '';
  document.getElementById('newCampaignDesc').value = '';
  
  // Mostrar c√≥digo de convite
  setTimeout(() => {
    showCampaignInvite(newCampaign.id);
  }, 500);
}

function loadCampaigns() {
  const container = document.getElementById('campaignCards');
  container.innerHTML = '';
  
  if (userData.campaigns.length === 0) {
    container.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
        <p>Nenhuma campanha encontrada.</p>
        <p>Crie uma campanha para come√ßar!</p>
      </div>
    `;
    return;
  }
  
  userData.campaigns.forEach(campaign => {
    const isMaster = campaign.master === currentUser.code;
    const playerCount = campaign.players.length;
    
    const card = document.createElement('div');
    card.className = 'character-card';
    card.innerHTML = `
      <div class="card-header">
        <div class="card-title">${campaign.name}</div>
        <div class="card-actions">
          ${isMaster ? `<button class="btn-icon" onclick="showCampaignInvite(${campaign.id})" title="Convidar">üìß</button>` : ''}
        </div>
      </div>
      <div class="card-content">
        <p>${campaign.description}</p>
        <p><strong>Mestre:</strong> ${campaign.masterName}</p>
        <p><strong>Jogadores:</strong> ${playerCount}</p>
      </div>
      <div class="card-footer">
        <button class="btn-primary" onclick="openCampaign(${campaign.id})">Abrir Campanha</button>
        ${isMaster ? `<button class="btn-secondary" onclick="manageCampaign(${campaign.id})">Gerenciar</button>` : ''}
      </div>
    `;
    container.appendChild(card);
  });
}

function generateInviteCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for (let i = 0; i < 8; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

function saveCampaignInviteCode(code, campaignId) {
  let campaignCodes = JSON.parse(localStorage.getItem('rpg_campaign_codes') || '{}');
  campaignCodes[code] = {
    campaignId: campaignId,
    master: currentUser.code,
    createdAt: new Date().toISOString()
  };
  localStorage.setItem('rpg_campaign_codes', JSON.stringify(campaignCodes));
}

function showCampaignInvite(campaignId) {
  const campaign = userData.campaigns.find(c => c.id === campaignId);
  if (!campaign) return;
  
  document.getElementById('campaignInviteCode').value = campaign.inviteCode;
  document.getElementById('inviteToCampaignModal').classList.add('active');
}

function closeInviteModal() {
  document.getElementById('inviteToCampaignModal').classList.remove('active');
}

function copyInviteCode() {
  const code = document.getElementById('campaignInviteCode');
  code.select();
  document.execCommand('copy');
  alert('C√≥digo copiado!');
}

function openCampaign(campaignId) {
  alert('Sistema de campanha em desenvolvimento!');
}

function manageCampaign(campaignId) {
  alert('Gerenciamento de campanha em desenvolvimento!');
}

// ========== NAVEGA√á√ÉO ==========

function openDashboardTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  document.querySelectorAll('.dashboard-tab').forEach(tab => {
    tab.classList.add('hidden');
  });
  
  const tabId = `tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
  document.getElementById(tabId).classList.remove('hidden');
}

// ========== SISTEMA DE FICHAS COMPLETO ==========

let currentCharacter = null;
let currentCharacterHabilidades = [];
let currentCharacterConjuracoes = [];
let historicoRolagens = [];

function openCharacterSheet(characterId) {
  const character = userData.characters.find(c => c.id === characterId);
  if (!character) return;
  
  currentCharacter = character;
  currentCharacterHabilidades = character.data.habilidades || [];
  currentCharacterConjuracoes = character.data.conjuracoes || [];
  historicoRolagens = [];
  
  document.getElementById('dashboardScreen').classList.add('hidden');
  document.getElementById('characterScreen').classList.remove('hidden');
  
  loadCharacterSheet(character);
}

function backToDashboard() {
  if (currentCharacter) {
    saveCharacterData();
  }
  
  document.getElementById('characterScreen').classList.add('hidden');
  document.getElementById('dashboardScreen').classList.remove('hidden');
  loadCharacters();
}

function loadCharacterSheet(character) {
  const container = document.getElementById('characterSheetContainer');
  
  container.innerHTML = `
    <h1>${character.name} - Ficha de Personagem</h1>
    
    <div class="container">
      <!-- COLUNA 1: PERSONAGEM E ATRIBUTOS -->
      <div>
        <div class="box">
          <h2>Personagem</h2>
          <label>Nome <input type="text" id="nome" value="${character.name}"></label>
          <label>Idade <input type="number" id="idade" value="${character.age}"></label>
          <label>Origem <input type="text" id="origem" value="${character.origin}"></label>
          
          <div class="modificador-section">
            <h3>Modificadores</h3>
            
            <div class="modificador-controls">
              <span>MDH</span>
              <button class="small" onclick="changeMDH(-5)">-5%</button>
              <span class="modificador-value" id="mdhValue">${character.data.modificadores.mdh}%</span>
              <button class="small" onclick="changeMDH(5)">+5%</button>
            </div>
            
            <div class="modificador-controls">
              <span>DE</span>
              <button class="small" onclick="changeDE(-5)">-5%</button>
              <span class="modificador-value" id="deValue">${character.data.modificadores.de}%</span>
              <button class="small" onclick="changeDE(5)">+5%</button>
            </div>
            
            <div id="mdhEffects" class="effects-list"></div>
            <div id="deEffects" class="effects-list"></div>
          </div>
        </div>

        <div class="box">
          <h2>Atributos</h2>
          <button onclick="rollAttributes()">üé≤ Rolar Atributos (1d4+1)</button>
          <small class="small">Sistema: 1d4+1, se resultado 2 ou 3: +1 no pr√≥ximo</small>
          
          <div class="atributo-row">
            <label>FOR <input type="number" id="FOR" value="${character.data.atributos.FOR}" min="2" max="6"></label>
            <button class="attribute-roll-btn" onclick="rollAttributeTest('FOR')">üé≤</button>
          </div>
          
          <div class="atributo-row">
            <label>DES <input type="number" id="DES" value="${character.data.atributos.DES}" min="2" max="6"></label>
            <button class="attribute-roll-btn" onclick="rollAttributeTest('DES')">üé≤</button>
          </div>
          
          <div class="atributo-row">
            <label>INT <input type="number" id="INT" value="${character.data.atributos.INT}" min="2" max="6"></label>
            <button class="attribute-roll-btn" onclick="rollAttributeTest('INT')">üé≤</button>
          </div>
          
          <div class="atributo-row">
            <label>CON <input type="number" id="CON" value="${character.data.atributos.CON}" min="2" max="6"></label>
            <button class="attribute-roll-btn" onclick="rollAttributeTest('CON')">üé≤</button>
          </div>
          
          <div class="atributo-row">
            <label>CONSC <input type="number" id="CONSC" value="${character.data.atributos.CONSC}" min="2" max="6"></label>
            <button class="attribute-roll-btn" onclick="rollAttributeTest('CONSC')">üé≤</button>
          </div>
          
          <div class="atributo-row">
            <label>CONH <input type="number" id="CONH" value="${character.data.atributos.CONH}" min="2" max="6"></label>
            <button class="attribute-roll-btn" onclick="rollAttributeTest('CONH')">üé≤</button>
          </div>
        </div>
      </div>

      <!-- COLUNA 2: PER√çCIAS -->
      <div>
        <div class="box">
          <h2>Per√≠cias</h2>
          <div id="listaPericias"></div>
        </div>
      </div>

      <!-- COLUNA 3: STATUS E EXTRAS -->
      <div>
        <div class="box">
          <h2>Status</h2>
          
          <div class="barra-container">
            <div class="barra-label">
              <span>Vida (PV)</span>
              <span id="vidaText">${character.data.status.vida.atual}/${character.data.status.vida.max}</span>
            </div>
            <input type="number" id="vidaAtual" min="0" value="${character.data.status.vida.atual}" style="width: 100%;">
            <div class="barra"><span id="barraVida"></span></div>
            <small class="small">Base: 10 + (CON √ó 2) + MDH</small>
          </div>
          
          <div class="barra-container">
            <div class="barra-label">
              <span>Sanidade</span>
              <span id="sanidadeText">${character.data.status.sanidade.atual}/${character.data.status.sanidade.max}</span>
            </div>
            <input type="number" id="sanidadeAtual" min="0" value="${character.data.status.sanidade.atual}" style="width: 100%;">
            <div class="barra"><span id="barraSanidade"></span></div>
            <small class="small">Base: 10 + CON + CONSC + MDH/DE</small>
          </div>
          
          <div class="barra-container">
            <div class="barra-label">
              <span>Fadiga (PF)</span>
              <span id="fadigaText">${character.data.status.fadiga.atual}/${character.data.status.fadiga.max}</span>
            </div>
            <input type="number" id="fadigaAtual" min="0" value="${character.data.status.fadiga.atual}" style="width: 100%;">
            <div class="barra"><span id="barraFadiga"></span></div>
            <small class="small">M√°ximo igual ao da Vida</small>
          </div>
          
          <div class="defesa-info">
            <h3>Sistema de Defesa</h3>
            <div class="defesa-item">
              <strong>Defesa Passiva (DES):</strong> 
              <span id="defesaPassivaText">Nenhuma</span>
              <button class="roll-btn" onclick="showDefesaPassiva()">Ver</button>
            </div>
            <div class="defesa-item">
              <strong>Defesa de Reflexo:</strong> 
              <span id="defesaReflexoText">-</span>
              <button class="roll-btn" onclick="rollDefesaReflexo()">Usar</button>
            </div>
            <div class="defesa-item">
              <strong>Bloqueio (CON + Guarda):</strong> 
              <span id="bloqueioText">-</span>
              <button class="roll-btn" onclick="rollBloqueio()">Usar</button>
            </div>
          </div>
        </div>

        <div class="box">
          <h2>Extras</h2>
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="openSheetTab('dados')">üé≤ Dados</button>
            <button class="tab-btn" onclick="openSheetTab('habilidades')">‚ú® Habilidades</button>
            <button class="tab-btn" onclick="openSheetTab('conjuracoes')">‚ö° Conjura√ß√µes</button>
            <button class="tab-btn" onclick="openSheetTab('historico')">üìú Hist√≥rico</button>
          </div>
          
          <div id="sheet-tab-dados" class="tab active">
            <h3>Rolagem de Dados</h3>
            <div class="dados-container">
              <button class="dado-btn" onclick="rollCustomDice('1d4')">1d4</button>
              <button class="dado-btn" onclick="rollCustomDice('1d6')">1d6</button>
              <button class="dado-btn" onclick="rollCustomDice('1d8')">1d8</button>
              <button class="dado-btn" onclick="rollCustomDice('1d10')">1d10</button>
              <button class="dado-btn" onclick="rollCustomDice('1d12')">1d12</button>
              <button class="dado-btn" onclick="rollCustomDice('1d20')">1d20</button>
              <button class="dado-btn" onclick="rollCustomDice('1d100')">1d100</button>
            </div>
            <input type="text" id="customDice" placeholder="Ex: 2d6+3" style="margin-top: 10px;">
            <button onclick="rollCustomDice(document.getElementById('customDice').value)">Rolar Customizado</button>
          </div>
          
          <div id="sheet-tab-habilidades" class="tab">
            <h3>Habilidades</h3>
            <button class="btn-primary" onclick="openCreateHabilidadeModal()">+ Criar Habilidade</button>
            <div id="listaHabilidadesSheet">
              ${renderHabilidades()}
            </div>
          </div>
          
          <div id="sheet-tab-conjuracoes" class="tab">
            <h3>Conjura√ß√µes de For√ßa</h3>
            <button class="btn-primary" onclick="openCreateConjuracaoModal()">+ Criar Conjura√ß√£o</button>
            <div id="listaConjuracoesSheet">
              ${renderConjuracoes()}
            </div>
          </div>
          
          <div id="sheet-tab-historico" class="tab">
            <h3>Hist√≥rico de Rolagens</h3>
            <div id="historicoRolagens">
              ${renderHistorico()}
            </div>
            <button onclick="clearHistory()" style="margin-top: 10px;">Limpar Hist√≥rico</button>
          </div>
        </div>
      </div>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
      <button class="btn-primary" onclick="saveCharacterData()" style="padding: 10px 30px;">üíæ Salvar Ficha</button>
    </div>
  `;
  
  initCharacterSheetSystem(character);
}

function renderHabilidades() {
  if (currentCharacterHabilidades.length === 0) {
    return '<div class="empty-state" style="text-align:center;padding:20px;color:#666">Nenhuma habilidade criada ainda.</div>';
  }
  
  return currentCharacterHabilidades.map(h => `
    <div class="habilidade-item">
      <div class="habilidade-header">
        <span class="habilidade-nome">${h.nome}</span>
        <button class="btn-icon" onclick="removerHabilidade('${h.id}')">üóëÔ∏è</button>
      </div>
      <div class="habilidade-stats">
        ${h.vida !== 0 ? `<span class="stat-badge">Vida: ${h.vida > 0 ? '+' : ''}${h.vida}</span>` : ''}
        ${h.sanidade !== 0 ? `<span class="stat-badge">Sanidade: ${h.sanidade > 0 ? '+' : ''}${h.sanidade}</span>` : ''}
        ${h.fadiga !== 0 ? `<span class="stat-badge">Fadiga: ${h.fadiga > 0 ? '+' : ''}${h.fadiga}</span>` : ''}
      </div>
      ${h.desc ? `<div class="habilidade-desc">${h.desc}</div>` : ''}
    </div>
  `).join('');
}

function renderConjuracoes() {
  if (currentCharacterConjuracoes.length === 0) {
    return '<div class="empty-state" style="text-align:center;padding:20px;color:#666">Nenhuma conjura√ß√£o criada ainda.</div>';
  }
  
  return currentCharacterConjuracoes.map(c => `
    <div class="conjuracao-item">
      <div class="conjuracao-header">
        <span class="conjuracao-nome">
          ${c.nome}
          <span class="elemento-badge ${c.elemento}">${c.elemento.charAt(0).toUpperCase() + c.elemento.slice(1)}</span>
          <span class="tecnologia-badge">${c.tecnologia}¬™ Tec</span>
        </span>
        <div>
          <button class="ataque-btn" onclick="rolarAtaqueConjuracao('${c.id}')">Atacar</button>
          <button class="btn-icon" onclick="removerConjuracao('${c.id}')">üóëÔ∏è</button>
        </div>
      </div>
      <div class="conjuracao-stats">
        <span class="stat-badge">Dano: ${c.dano}${c.modDano !== 0 ? (c.modDano > 0 ? '+' : '') + c.modDano : ''}</span>
      </div>
      ${c.desc ? `<div class="conjuracao-desc">${c.desc}</div>` : ''}
    </div>
  `).join('');
}

function renderHistorico() {
  if (historicoRolagens.length === 0) {
    return '<div class="empty-state" style="text-align:center;padding:20px;color:#666">Nenhuma rolagem registrada.</div>';
  }
  
  return historicoRolagens.map(item => `
    <div class="historico-item">
      <strong>${item.time}</strong> ${item.icone} ${item.acao}<br>
      <small>${item.detalhes}</small>
    </div>
  `).join('');
}

// ========== SISTEMA DE PER√çCIAS ==========

const pericias = [
  ["Acrobacia", ["DES"]],
  ["Artes", ["INT"]],
  ["Atletismo", ["FOR"]],
  ["Arrombamento", ["FOR"]],
  ["Autocuidado", ["CON"]],
  ["Bordar", ["DES"]],
  ["Ci√™ncias", ["INT"]],
  ["Criar", ["INT"]],
  ["Crime", ["DES"]],
  ["Diplomacia", ["CONSC"]],
  ["Disciplina", ["CONSC"]],
  ["Distrair", ["CONSC"]],
  ["Enfermagem", ["INT","CONH"]],
  ["Engana√ß√£o", ["CONSC"]],
  ["Furtividade", ["DES"]],
  ["Fuga", ["DES","INT"]],
  ["Fortitude", ["CON"]],
  ["Guarda", ["CON"]],
  ["Iniciativa", ["FOR","DES"]],
  ["Intercepta√ß√£o", ["DES"]],
  ["Intimida√ß√£o", ["CONSC"]],
  ["Intui√ß√£o", ["CONSC"]],
  ["Luta", ["FOR"]],
  ["Maquinaria", ["INT","FOR"]],
  ["Pontaria", ["DES"]],
  ["Pilotagem", ["DES","INT"]],
  ["Profiss√£o", ["INT"]],
  ["Reflexos", ["DES"]],
  ["Religi√£o", ["CONSC"]],
  ["Sobreviv√™ncia", ["INT"]],
  ["Saber", ["CONH"]],
  ["T√°tica", ["INT"]],
  ["Tecnologia", ["INT"]],
  ["Vontade", ["CONSC"]]
];

const niveisPericia = {
  "N√£o Treinada": { acertosNecessarios: 3, bonus: 0 },
  "Treinada": { acertosNecessarios: 3, bonus: 1 },
  "Profissional": { acertosNecessarios: 2, bonus: 2 },
  "Expert": { acertosNecessarios: 1, bonus: 3 }
};

function initCharacterSheetSystem(character) {
  criarPericias(character);
  atualizarBarras();
  atualizarModificadores();
  configurarEventListeners();
}

function criarPericias(character) {
  const lista = document.getElementById("listaPericias");
  if (!lista) return;
  
  lista.innerHTML = "";

  pericias.forEach(([nome, atributos]) => {
    const div = document.createElement("div");
    div.className = "pericia";
    
    const top = document.createElement("div");
    top.className = "pericia-top";
    
    const nomeSpan = document.createElement("strong");
    nomeSpan.textContent = nome;
    
    const selectAtributo = document.createElement("select");
    selectAtributo.className = "select-atributo";
    atributos.forEach(atr => {
      const option = document.createElement("option");
      option.value = atr;
      option.textContent = atr;
      selectAtributo.appendChild(option);
    });
    
    const selectNivel = document.createElement("select");
    selectNivel.className = "select-nivel";
    
    const nivelSalvo = character.data.pericias && character.data.pericias[nome];
    
    Object.keys(niveisPericia).forEach(nivel => {
      const option = document.createElement("option");
      option.value = nivel;
      option.textContent = nivel;
      if ((nivelSalvo && nivel === nivelSalvo) || (!nivelSalvo && nivel === "N√£o Treinada")) {
        option.selected = true;
      }
      selectNivel.appendChild(option);
    });
    
    const btn = document.createElement("button");
    btn.textContent = "Rolar";
    btn.className = "btn-rolar-pericia";
    btn.style.width = "70px";
    btn.onclick = () => {
      rolarPericiaD6(nome, selectAtributo.value, selectNivel.value);
    };
    
    top.appendChild(nomeSpan);
    top.appendChild(selectAtributo);
    top.appendChild(selectNivel);
    top.appendChild(btn);
    
    div.appendChild(top);
    lista.appendChild(div);
  });
}

// ========== HABILIDADES ==========

function openCreateHabilidadeModal() {
  document.getElementById('createHabilidadeModal').classList.add('active');
}

function closeCreateHabilidadeModal() {
  document.getElementById('createHabilidadeModal').classList.remove('active');
}

function salvarHabilidade() {
  const nome = document.getElementById('habilidadeNome').value.trim();
  const vida = parseInt(document.getElementById('habilidadeVida').value) || 0;
  const sanidade = parseInt(document.getElementById('habilidadeSanidade').value) || 0;
  const fadiga = parseInt(document.getElementById('habilidadeFadiga').value) || 0;
  const desc = document.getElementById('habilidadeDesc').value.trim();
  
  if (!nome) {
    alert('Digite um nome para a habilidade!');
    return;
  }
  
  const novaHabilidade = {
    id: Date.now().toString(),
    nome: nome,
    vida: vida,
    sanidade: sanidade,
    fadiga: fadiga,
    desc: desc
  };
  
  currentCharacterHabilidades.push(novaHabilidade);
  
  // Atualizar display
  document.getElementById('listaHabilidadesSheet').innerHTML = renderHabilidades();
  
  closeCreateHabilidadeModal();
  
  // Limpar formul√°rio
  document.getElementById('habilidadeNome').value = '';
  document.getElementById('habilidadeVida').value = '0';
  document.getElementById('habilidadeSanidade').value = '0';
  document.getElementById('habilidadeFadiga').value = '0';
  document.getElementById('habilidadeDesc').value = '';
  
  alert('Habilidade criada com sucesso!');
}

function removerHabilidade(id) {
  if (confirm('Remover esta habilidade?')) {
    currentCharacterHabilidades = currentCharacterHabilidades.filter(h => h.id !== id);
    document.getElementById('listaHabilidadesSheet').innerHTML = renderHabilidades();
  }
}

// ========== CONJURA√á√ïES ==========

function openCreateConjuracaoModal() {
  document.getElementById('createConjuracaoModal').classList.add('active');
}

function closeCreateConjuracaoModal() {
  document.getElementById('createConjuracaoModal').classList.remove('active');
}

function salvarConjuracao() {
  const nome = document.getElementById('conjuracaoNome').value.trim();
  const elemento = document.getElementById('conjuracaoElemento').value;
  const tecnologia = document.getElementById('conjuracaoTecnologia').value;
  const dano = document.getElementById('conjuracaoDano').value;
  const modDano = parseInt(document.getElementById('conjuracaoModDano').value) || 0;
  const desc = document.getElementById('conjuracaoDesc').value.trim();
  
  if (!nome) {
    alert('Digite um nome para a conjura√ß√£o!');
    return;
  }
  
  if (!dano.match(/^\d+d\d+$/)) {
    alert('Formato de dano inv√°lido! Use formato como: 2d6, 3d8, etc.');
    return;
  }
  
  const novaConjuracao = {
    id: Date.now().toString(),
    nome: nome,
    elemento: elemento,
    tecnologia: tecnologia,
    dano: dano,
    modDano: modDano,
    desc: desc
  };
  
  currentCharacterConjuracoes.push(novaConjuracao);
  
  // Atualizar display
  document.getElementById('listaConjuracoesSheet').innerHTML = renderConjuracoes();
  
  closeCreateConjuracaoModal();
  
  // Limpar formul√°rio
  document.getElementById('conjuracaoNome').value = '';
  document.getElementById('conjuracaoDano').value = '1d6';
  document.getElementById('conjuracaoModDano').value = '0';
  document.getElementById('conjuracaoDesc').value = '';
  
  alert('Conjura√ß√£o criada com sucesso!');
}

function removerConjuracao(id) {
  if (confirm('Remover esta conjura√ß√£o?')) {
    currentCharacterConjuracoes = currentCharacterConjuracoes.filter(c => c.id !== id);
    document.getElementById('listaConjuracoesSheet').innerHTML = renderConjuracoes();
  }
}

function rolarAtaqueConjuracao(id) {
  const conjuracao = currentCharacterConjuracoes.find(c => c.id === id);
  if (!conjuracao) return;
  
  const int = parseInt(document.getElementById('INT').value) || 0;
  const forValue = parseInt(document.getElementById('FOR').value) || 0;
  
  // Rolagem de ataque
  const dadosAtaque = [];
  let acertosAtaque = 0;
  const totalDadosAtaque = int + forValue;
  
  for (let i = 0; i < totalDadosAtaque; i++) {
    const resultado = Math.floor(Math.random() * 6) + 1;
    dadosAtaque.push(resultado);
    if (resultado >= 4) acertosAtaque++;
  }
  
  // Rolagem de dano
  const match = conjuracao.dano.match(/^(\d+)d(\d+)$/);
  const qtdDados = parseInt(match[1]);
  const faces = parseInt(match[2]);
  const dadosDano = [];
  let totalDano = 0;
  
  for (let i = 0; i < qtdDados; i++) {
    const resultado = Math.floor(Math.random() * faces) + 1;
    dadosDano.push(resultado);
    totalDano += resultado;
  }
  
  totalDano += conjuracao.modDano;
  
  const mensagem = `
    ‚ö° ATAQUE: ${conjuracao.nome} ‚ö°
    
    Elemento: ${conjuracao.elemento}
    Tecnologia: ${conjuracao.tecnologia}¬™
    
    --- ATAQUE (Maquinaria) ---
    INT: ${int} + FOR: ${forValue} = ${totalDadosAtaque}d6
    Dados: ${dadosAtaque.map(d => `${d}${d >= 4 ? '‚úÖ' : '‚ùå'}`).join(', ')}
    Acertos: ${acertosAtaque}/${totalDadosAtaque}
    
    --- DANO ---
    F√≥rmula: ${conjuracao.dano}${conjuracao.modDano !== 0 ? (conjuracao.modDano > 0 ? '+' : '') + conjuracao.modDano : ''}
    Dados: ${dadosDano.join(', ')}
    Total: ${totalDano}
  `;
  
  alert(mensagem);
  
  addToHistory(conjuracao.nome, "‚ö°", 
    `Ataque: ${acertosAtaque}/${totalDadosAtaque} acertos | Dano: ${totalDano}`);
}

// ========== FUN√á√ïES DO SISTEMA DE FICHA ==========

function configurarEventListeners() {
  document.querySelectorAll('#FOR, #DES, #INT, #CON, #CONSC, #CONH').forEach(input => {
    input.addEventListener('change', atualizarStatus);
  });
  
  document.querySelectorAll('#vidaAtual, #sanidadeAtual, #fadigaAtual').forEach(input => {
    input.addEventListener('input', atualizarBarras);
  });
  
  document.getElementById('nome').addEventListener('change', saveCharacterData);
  document.getElementById('idade').addEventListener('change', saveCharacterData);
  document.getElementById('origem').addEventListener('change', saveCharacterData);
}

function atualizarStatus() {
  const con = parseInt(document.getElementById("CON").value) || 0;
  const mdh = parseInt(document.getElementById("mdhValue").textContent) || 0;
  
  const vidaMax = 10 + (con * 2) + Math.floor(mdh / 5);
  const sanidadeMax = 10 + con + (parseInt(document.getElementById("CONSC").value) || 0);
  const fadigaMax = vidaMax;
  
  const vidaAtualInput = document.getElementById("vidaAtual");
  const sanidadeAtualInput = document.getElementById("sanidadeAtual");
  const fadigaAtualInput = document.getElementById("fadigaAtual");
  
  vidaAtualInput.max = vidaMax;
  sanidadeAtualInput.max = sanidadeMax;
  fadigaAtualInput.max = fadigaMax;
  
  document.getElementById("vidaText").textContent = `${vidaAtualInput.value}/${vidaMax}`;
  document.getElementById("sanidadeText").textContent = `${sanidadeAtualInput.value}/${sanidadeMax}`;
  document.getElementById("fadigaText").textContent = `${fadigaAtualInput.value}/${fadigaMax}`;
  
  atualizarBarras();
}

function atualizarBarras() {
  const barras = [
    { atual: "vidaAtual", barra: "barraVida" },
    { atual: "sanidadeAtual", barra: "barraSanidade" },
    { atual: "fadigaAtual", barra: "barraFadiga" }
  ];
  
  barras.forEach(config => {
    const input = document.getElementById(config.atual);
    const barra = document.getElementById(config.barra);
    
    if (input && barra) {
      const atual = parseInt(input.value) || 0;
      const max = parseInt(input.max) || 100;
      const porcentagem = max > 0 ? (atual / max) * 100 : 0;
      
      barra.style.width = `${Math.min(100, Math.max(0, porcentagem))}%`;
      
      if (porcentagem > 60) barra.style.background = "#4CAF50";
      else if (porcentagem > 30) barra.style.background = "#FF9800";
      else barra.style.background = "#f44336";
    }
  });
}

function atualizarModificadores() {
  const mdh = parseInt(document.getElementById("mdhValue").textContent) || 0;
  const de = parseInt(document.getElementById("deValue").textContent) || 100;
  
  let mdhEffects = "";
  let deEffects = "";
  
  if (mdh >= 5 && mdh <= 35) {
    const steps = Math.floor(mdh / 5);
    mdhEffects += `<div class="effect-item">+${steps} PV MAX</div>`;
    mdhEffects += `<div class="effect-item">+${steps} PF MAX</div>`;
  }
  
  if (mdh >= 65 && mdh <= 95) {
    const steps = Math.floor((mdh - 65) / 5);
    mdhEffects += `<div class="effect-item">-${steps} Sanidade MAX</div>`;
  }
  
  if (mdh === 99) {
    mdhEffects += `<div class="effect-item"><strong>99% - Sanidade MAX: 5</strong></div>`;
  }
  
  if (de <= 50 && de > 30) {
    const steps = Math.floor((50 - de) / 5);
    deEffects += `<div class="effect-item">-${steps} Sanidade MAX</div>`;
  }
  
  if (de <= 5) {
    deEffects += `<div class="effect-item"><strong>Sanidade MAX: 5</strong></div>`;
  }
  
  const mdhEffectsDiv = document.getElementById("mdhEffects");
  const deEffectsDiv = document.getElementById("deEffects");
  
  if (mdhEffectsDiv) mdhEffectsDiv.innerHTML = mdhEffects || "Sem efeitos";
  if (deEffectsDiv) deEffectsDiv.innerHTML = deEffects || "Sem efeitos negativos";
}

function changeMDH(valor) {
  const mdhValue = document.getElementById("mdhValue");
  let mdh = parseInt(mdhValue.textContent) || 0;
  
  mdh += valor;
  if (mdh < 0) mdh = 0;
  if (mdh > 99) mdh = 99;
  
  mdhValue.textContent = mdh + "%";
  atualizarModificadores();
  atualizarStatus();
}

function changeDE(valor) {
  const deValue = document.getElementById("deValue");
  let de = parseInt(deValue.textContent) || 100;
  
  de += valor;
  if (de < 0) de = 0;
  if (de > 100) de = 100;
  
  deValue.textContent = de + "%";
  atualizarModificadores();
  atualizarStatus();
}

// ========== SISTEMA DE ROLAGEM ==========

function rolarPericiaD6(nomePericia, atributo, nivel) {
  const valorAtributo = parseInt(document.getElementById(atributo).value) || 0;
  const config = niveisPericia[nivel];
  const acertosNecessarios = config.acertosNecessarios;
  const bonus = config.bonus;
  
  const dados = [];
  let acertosNaturais = 0;
  
  for (let i = 0; i < valorAtributo; i++) {
    const resultado = Math.floor(Math.random() * 6) + 1;
    dados.push(resultado);
    if (resultado >= 4) acertosNaturais++;
  }
  
  const totalAcertos = Math.min(acertosNaturais + bonus, valorAtributo);
  const sucesso = totalAcertos >= acertosNecessarios;
  
  const mensagem = `
    üé≤ TESTE DE ${nomePericia.toUpperCase()} üé≤
    
    Atributo: ${atributo} (${valorAtributo} dados D6)
    N√≠vel: ${nivel} (${acertosNecessarios} acertos necess√°rios)
    B√¥nus do n√≠vel: +${bonus}
    
    Dados: ${dados.map(d => `${d}${d >= 4 ? '‚úÖ' : '‚ùå'}`).join(', ')}
    
    Acertos naturais: ${acertosNaturais}
    + B√¥nus: ${bonus}
    Total: ${totalAcertos} acertos
    
    ${sucesso ? 'üéâ SUCESSO!' : 'üíÄ FALHA!'} (${totalAcertos}/${acertosNecessarios})
  `;
  
  alert(mensagem);
  
  addToHistory(nomePericia, sucesso ? "‚úÖ" : "‚ùå", 
    `${acertosNaturais}+${bonus}=${totalAcertos}/${acertosNecessarios} acertos`);
}

function rollAttributes() {
  const attributes = ["FOR", "DES", "INT", "CON", "CONSC", "CONH"];
  let results = [];
  let bonusNext = 0;
  
  for (let i = 0; i < attributes.length; i++) {
    const roll = Math.floor(Math.random() * 4) + 1 + 1;
    let finalValue = roll + bonusNext;
    
    if (finalValue < 2) finalValue = 2;
    if (finalValue > 6) finalValue = 6;
    
    bonusNext = (roll === 2 || roll === 3) ? 1 : 0;
    
    results.push({
      attribute: attributes[i],
      roll: roll,
      bonus: bonusNext,
      final: finalValue
    });
    
    document.getElementById(attributes[i]).value = finalValue;
  }
  
  const mensagem = results.map(r => 
    `${r.attribute}: 1d4+1 = ${r.roll} ${r.bonus ? '+1 do anterior' : ''} = ${r.final}`
  ).join('\n');
  
  alert("üé≤ ROLAGEM DE ATRIBUTOS (1d4+1)\n\n" + mensagem);
  
  atualizarStatus();
}

function rollAttributeTest(atributo) {
  const valor = parseInt(document.getElementById(atributo).value) || 0;
  const dados = [];
  let acertos = 0;
  
  for (let i = 0; i < valor; i++) {
    const resultado = Math.floor(Math.random() * 6) + 1;
    dados.push(resultado);
    if (resultado >= 4) acertos++;
  }
  
  alert(`Teste de ${atributo} (${valor}d6):\n\n` +
        `Dados: ${dados.map(d => `${d}${d >= 4 ? '‚úÖ' : '‚ùå'}`).join(', ')}\n` +
        `Acertos: ${acertos}/${valor}`);
  
  addToHistory(atributo, "üé≤", `${acertos}/${valor} acertos`);
}

function rollCustomDice(formula) {
  if (!formula) formula = document.getElementById("customDice").value || "1d6";
  
  const match = formula.match(/(\d+)?d(\d+)([+-]\d+)?/i);
  if (!match) {
    alert("F√≥rmula inv√°lida! Use formato como: 2d6+3");
    return;
  }
  
  const quantidade = parseInt(match[1]) || 1;
  const faces = parseInt(match[2]);
  const modificador = parseInt(match[3]) || 0;
  
  const resultados = [];
  let total = 0;
  
  for (let i = 0; i < quantidade; i++) {
    const resultado = Math.floor(Math.random() * faces) + 1;
    resultados.push(resultado);
    total += resultado;
  }
  
  total += modificador;
  
  alert(`Rolagem: ${formula}\n\n` +
        `Resultados: ${resultados.join(', ')}\n` +
        (modificador !== 0 ? `Modificador: ${modificador > 0 ? '+' : ''}${modificador}\n` : '') +
        `Total: ${total}`);
  
  addToHistory(formula, "üé≤", `[${resultados.join(',')}]${modificador ? (modificador > 0 ? '+' : '') + modificador : ''}=${total}`);
}

function addToHistory(acao, icone, detalhes) {
  const item = {
    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
    acao: acao,
    icone: icone,
    detalhes: detalhes
  };
  
  historicoRolagens.unshift(item);
  
  if (historicoRolagens.length > 10) historicoRolagens.pop();
  
  updateHistoryDisplay();
}

function updateHistoryDisplay() {
  const container = document.getElementById("historicoRolagens");
  if (!container) return;
  
  container.innerHTML = renderHistorico();
}

function clearHistory() {
  historicoRolagens = [];
  updateHistoryDisplay();
}

// ========== FUN√á√ïES DA FICHA ==========

function openSheetTab(tabName) {
  document.querySelectorAll('#characterSheetContainer .tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  document.querySelectorAll('#characterSheetContainer .tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.getElementById(`sheet-tab-${tabName}`).classList.add('active');
}

function showDefesaPassiva() {
  const des = parseInt(document.getElementById("DES").value) || 0;
  let defesa = "Nenhuma";
  
  if (des >= 3) {
    if (des === 3) defesa = "-1d6 do ataque do oponente (aleat√≥rio)";
    else if (des === 4) defesa = "-1d6 e -1 extra";
    else if (des === 5) defesa = "-1d6 e -2 extra";
    else if (des >= 6) defesa = "-2d6";
  }
  
  document.getElementById("defesaPassivaText").textContent = defesa;
  
  alert(`Defesa Passiva (DES ${des}):\n\n${defesa}`);
}

function rollDefesaReflexo() {
  alert("Sistema de Defesa de Reflexo - Use a per√≠cia Reflexos!");
}

function rollBloqueio() {
  const con = parseInt(document.getElementById("CON").value) || 0;
  alert(`Bloqueio (CON ${con} + Guarda):\n\nUse a per√≠cia Guarda para bloquear ataques!`);
}

// ========== SALVAR DADOS DA FICHA ==========

function saveCharacterData() {
  if (!currentCharacter) return;
  
  const updatedData = {
    atributos: {
      FOR: parseInt(document.getElementById('FOR').value) || 2,
      DES: parseInt(document.getElementById('DES').value) || 2,
      INT: parseInt(document.getElementById('INT').value) || 2,
      CON: parseInt(document.getElementById('CON').value) || 2,
      CONSC: parseInt(document.getElementById('CONSC').value) || 2,
      CONH: parseInt(document.getElementById('CONH').value) || 5
    },
    status: {
      vida: {
        atual: parseInt(document.getElementById('vidaAtual').value) || 10,
        max: parseInt(document.getElementById('vidaAtual').max) || 10
      },
      sanidade: {
        atual: parseInt(document.getElementById('sanidadeAtual').value) || 15,
        max: parseInt(document.getElementById('sanidadeAtual').max) || 15
      },
      fadiga: {
        atual: parseInt(document.getElementById('fadigaAtual').value) || 10,
        max: parseInt(document.getElementById('fadigaAtual').max) || 10
      }
    },
    modificadores: {
      mdh: parseInt(document.getElementById('mdhValue').textContent) || 0,
      de: parseInt(document.getElementById('deValue').textContent) || 100
    },
    habilidades: currentCharacterHabilidades,
    conjuracoes: currentCharacterConjuracoes,
    pericias: {}
  };
  
  // Coletar n√≠veis das per√≠cias
  document.querySelectorAll('.pericia').forEach(periciaDiv => {
    const nome = periciaDiv.querySelector('strong').textContent;
    const nivel = periciaDiv.querySelector('.select-nivel').value;
    updatedData.pericias[nome] = nivel;
  });
  
  // Atualizar character
  currentCharacter.name = document.getElementById('nome').value;
  currentCharacter.age = parseInt(document.getElementById('idade').value) || 25;
  currentCharacter.origin = document.getElementById('origem').value;
  currentCharacter.data = updatedData;
  
  // Atualizar na lista de characters
  const index = userData.characters.findIndex(c => c.id === currentCharacter.id);
  if (index !== -1) {
    userData.characters[index] = currentCharacter;
    saveUserData();
  }
  
  alert('Ficha salva com sucesso!');
}

// ========== INICIALIZA√á√ÉO ==========

window.addEventListener('load', function() {
  const savedUser = localStorage.getItem('current_user');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    if (accessCodes[currentUser.code]) {
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userCode').textContent = currentUser.code;
      document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
      document.getElementById('adminTabBtn').classList.toggle('hidden', !currentUser.isAdmin);
      
      loadUserData();
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboardScreen').classList.remove('hidden');
      loadCharacters();
      loadCampaigns();
      loadAccessCodesList();
    }
  }
});

window.addEventListener('beforeunload', function() {
  if (currentUser) {
    localStorage.setItem('current_user', JSON.stringify(currentUser));
  }
});
</script>
</body>
</html>